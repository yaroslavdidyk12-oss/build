<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ĞŸĞ»Ğ°Ğ½ Ğ±ĞµĞ·Ğ¿ĞµĞºĞ¸</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2f80ed">

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f2f4f7;padding:8px}
h1{text-align:center;margin:6px 0}

.controls, .tabs{
  display:flex;
  gap:4px;
  flex-wrap:wrap;
  margin-bottom:6px;
}

button, select{
  padding:6px;
  font-size:12px;
}

.tabs button{
  flex:1;
  border:none;
  border-radius:5px;
  background:#ddd;
}
.tabs button.active{
  background:#2f80ed;
  color:#fff;
}

section{display:none}
section.active{display:block}

.item{
  display:flex;
  align-items:center;
  gap:4px;
  background:#fff;
  padding:4px;
  border-radius:5px;
  margin-bottom:3px;
}
.item.have{background:#d4edda}

.item input[type=text]{width:90px}
.item input[type=number]{width:40px}

#marked{
  background:#e9f7ef;
  padding:6px;
  border-radius:5px;
  margin-top:6px;
}
</style>
</head>

<body>

<h1>ğŸ›¡ï¸ ĞŸĞ»Ğ°Ğ½ Ğ±ĞµĞ·Ğ¿ĞµĞºĞ¸</h1>

<div class="controls">
  <select id="hours">
    <option value="24">24 Ğ³Ğ¾Ğ´</option>
    <option value="48">48 Ğ³Ğ¾Ğ´</option>
    <option value="72" selected>72 Ğ³Ğ¾Ğ´</option>
  </select>

  <button onclick="showMissing()">ğŸ” Ğ’Ñ–Ğ´ÑÑƒÑ‚Ğ½Ñ”</button>
  <button onclick="showAll()">ğŸ” Ğ’ÑĞµ</button>
  <button onclick="exportXLSX()">ğŸ“Š Excel</button>
  <button onclick="exportPDF()">ğŸ“„ PDF</button>
  <button onclick="exportPrintXLSX()">ğŸ–¨ Ğ§ĞµĞº-Ğ»Ğ¸ÑÑ‚</button>
  <button onclick="resetData()">â™»ï¸ Ğ’Ñ–Ğ´Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸</button>
</div>

<div class="tabs">
  <button data-tab="home">ğŸ  Ğ’Ğ´Ğ¾Ğ¼Ğ°</button>
  <button data-tab="evac">ğŸ’ Ğ•Ğ²Ğ°ĞºÑƒĞ°Ñ†Ñ–Ñ</button>
  <button data-tab="car">ğŸš— ĞĞ²Ñ‚Ğ¾</button>
</div>

<section id="home"></section>
<section id="evac"></section>
<section id="car"></section>

<div id="marked"></div>

<script>
let hours="72";

const baseData={
 home:{title:"ğŸ  Ğ’Ğ´Ğ¾Ğ¼Ğ°",items:[
  {name:"Ğ’Ğ¾Ğ´Ğ° (Ğ»)",base:3,perDay:true},
  {name:"Ğ‡Ğ¶Ğ°",base:2,perDay:true},
  {name:"ĞĞ¿Ñ‚ĞµÑ‡ĞºĞ°",base:1,perDay:false}
 ]},
 evac:{title:"ğŸ’ Ğ•Ğ²Ğ°ĞºÑƒĞ°Ñ†Ñ–Ñ",items:[
  {name:"Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¸",base:1,perDay:false},
  {name:"Ğ’Ğ¾Ğ´Ğ° (Ğ»)",base:2,perDay:true}
 ]},
 car:{title:"ğŸš— ĞĞ²Ñ‚Ğ¾",items:[
  {name:"ĞĞ¿Ñ‚ĞµÑ‡ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾",base:1,perDay:false},
  {name:"ĞšĞ¾Ğ²Ğ´Ñ€Ğ°",base:2,perDay:false}
 ]}
};

let data=JSON.parse(localStorage.getItem("plan_safe"))
  || JSON.parse(JSON.stringify(baseData));

["home","evac","car"].forEach(s=>{
 data[s].items.forEach(i=>{
  if(!i.checked) i.checked={24:false,48:false,72:false};
 });
});

function save(){
 localStorage.setItem("plan_safe",JSON.stringify(data));
}

function qty(i){
 return i.perDay ? Math.ceil(i.base*(hours/24)) : i.base;
}

function render(){
 ["home","evac","car"].forEach(sec=>{
  const el=document.getElementById(sec);
  el.innerHTML=`<h3>${data[sec].title}</h3>`;

  data[sec].items.forEach((i,idx)=>{
   const d=document.createElement("div");
   d.className="item"+(i.checked[hours]?" have":"");
   d.innerHTML=`
    <input type="checkbox" ${i.checked[hours]?"checked":""}>
    <input type="text" value="${i.name}">
    <input type="number" value="${qty(i)}">
    <input type="checkbox" ${i.perDay?"checked":""}>Ğ´ĞµĞ½ÑŒ
    <button>ğŸ—‘ï¸</button>
   `;

   d.children[0].onchange=e=>{
    i.checked[hours]=e.target.checked;
    save();render();
   };
   d.children[1].onchange=e=>{
    i.name=e.target.value;save();
   };
   d.children[2].onchange=e=>{
    const v=Number(e.target.value);
    if(v>0){
     i.base=i.perDay?Math.ceil(v/(hours/24)):v;
     save();render();
    }
   };
   d.children[3].onchange=e=>{
    i.perDay=e.target.checked;
    save();render();
   };
   d.children[4].onclick=()=>{
    data[sec].items.splice(idx,1);
    save();render();
   };

   el.appendChild(d);
  });

  const add=document.createElement("button");
  add.textContent="â• Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ€Ñ–Ñ‡";
  add.onclick=()=>addItem(sec);
  el.appendChild(add);
 });

 renderMarked();
}

function addItem(sec){
 const name=prompt("ĞĞ°Ğ·Ğ²Ğ° Ñ€ĞµÑ‡Ñ–","");
 if(!name) return;
 data[sec].items.push({
  name,
  base:1,
  perDay:false,
  checked:{24:false,48:false,72:false}
 });
 save();render();
}

function renderMarked(){
 const m=document.getElementById("marked");
 m.innerHTML="<b>Ğ’Ñ–Ğ´Ğ¼Ñ–Ñ‡ĞµĞ½Ñ–:</b><br>";
 ["home","evac","car"].forEach(s=>{
  data[s].items.forEach(i=>{
   if(i.checked[hours]){
    m.innerHTML+=`${data[s].title} â€” ${i.name} (${qty(i)})<br>`;
   }
  });
 });
}

function showMissing(){
 document.querySelectorAll(".item").forEach(i=>{
  i.style.display=i.classList.contains("have")?"none":"flex";
 });
}
function showAll(){
 document.querySelectorAll(".item").forEach(i=>i.style.display="flex");
}

function resetData(){
 if(confirm("Ğ’Ñ–Ğ´Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½?")){
  data=JSON.parse(JSON.stringify(baseData));
  ["home","evac","car"].forEach(s=>{
   data[s].items.forEach(i=>i.checked={24:false,48:false,72:false});
  });
  save();render();
 }
}

document.getElementById("hours").onchange=e=>{
 hours=e.target.value;
 render();
};

/* ====== EXPORTS ====== */

// XLSX â€” Ğ’Ğ¡Ğ• Ğ’ ĞĞ”ĞĞĞœĞ£
function exportXLSX(){
 const rows=[["Ğ¢Ğ¸Ğ¿","ĞĞ°Ğ·Ğ²Ğ°","24 Ğ³Ğ¾Ğ´","48 Ğ³Ğ¾Ğ´","72 Ğ³Ğ¾Ğ´","Ğ”ĞµĞ½ÑŒ"]];
 const icon={home:"ğŸ ",evac:"ğŸ’",car:"ğŸš—"};

 ["home","evac","car"].forEach(s=>{
  data[s].items.forEach(i=>{
   rows.push([
    icon[s],
    i.name,
    i.perDay?i.base*1:i.base,
    i.perDay?i.base*2:i.base,
    i.perDay?i.base*3:i.base,
    i.perDay?"Ñ‚Ğ°Ğº":"Ğ½Ñ–"
   ]);
  });
 });

 const ws=XLSX.utils.aoa_to_sheet(rows);
 ws["!cols"]=[{wch:6},{wch:30},{wch:8},{wch:8},{wch:8},{wch:12}];
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"ĞŸĞ»Ğ°Ğ½");
 XLSX.writeFile(wb,"plan_all.xlsx");
}

// PDF â€” Ğ¯Ğš Ğ•ĞšĞ ĞĞ
function exportPDF(){
 const {jsPDF}=window.jspdf;
 const pdf=new jsPDF();
 let y=10;

 pdf.setFontSize(14);
 pdf.text(`ĞŸĞ»Ğ°Ğ½ Ğ½Ğ° ${hours} Ğ³Ğ¾Ğ´`,10,y);y+=8;
 pdf.setFontSize(11);

 ["home","evac","car"].forEach(s=>{
  pdf.text(data[s].title,10,y);y+=6;
  data[s].items.forEach(i=>{
   const m=i.checked[hours]?"â˜‘":"â˜";
   pdf.text(`${m} ${i.name} â€” ${qty(i)}`,12,y);
   y+=5;
   if(y>280){pdf.addPage();y=10;}
  });
  y+=4;
 });

 pdf.save(`plan_${hours}h.pdf`);
}

// XLSX â€” Ğ§Ğ˜Ğ¡Ğ¢Ğ˜Ğ™ Ğ§Ğ•Ğš-Ğ›Ğ˜Ğ¡Ğ¢
function exportPrintXLSX(){
 const rows=[["ĞœĞ°Ñ","Ğ Ñ–Ñ‡","Ğš-ÑÑ‚ÑŒ","Ğ”ĞµĞ½ÑŒ"]];
 ["home","evac","car"].forEach(s=>{
  rows.push(["",data[s].title,"",""]);
  data[s].items.forEach(i=>{
   rows.push(["â˜",i.name,qty(i),i.perDay?"Ñ‚Ğ°Ğº":"Ğ½Ñ–"]);
  });
 });
 const ws=XLSX.utils.aoa_to_sheet(rows);
 ws["!cols"]=[{wch:6},{wch:35},{wch:8},{wch:10}];
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Ğ§ĞµĞº-Ğ»Ğ¸ÑÑ‚");
 XLSX.writeFile(wb,`checklist_${hours}h.xlsx`);
}

/* tabs */
document.querySelectorAll(".tabs button").forEach(b=>{
 b.onclick=()=>{
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.querySelectorAll(".tabs button").forEach(x=>x.classList.remove("active"));
  document.getElementById(b.dataset.tab).classList.add("active");
  b.classList.add("active");
 };
});

render();
document.querySelector(".tabs button").click();
</script>

</body>
</html>
