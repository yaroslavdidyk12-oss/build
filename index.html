<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–ü–ª–∞–Ω –±–µ–∑–ø–µ–∫–∏</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2f80ed">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f4f7;
  margin: 0;
  padding: 8px;
}
h1 {
  text-align: center;
  margin-bottom: 8px;
  font-size: 20px;
}
.tabs {
  display: flex;
  gap: 3px;
  margin-bottom: 8px;
}
.tabs button {
  flex: 1;
  padding: 8px;
  border: none;
  background: #ddd;
  font-size: 12px;
  cursor: pointer;
  border-radius: 5px;
}
.tabs button.active {
  background: #2f80ed;
  color: #fff;
}
.controls {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
  justify-content: center;
  margin-bottom: 8px;
}
.controls input[type=text] {
  padding: 4px;
  flex: 1;
  font-size: 12px;
  border-radius: 4px;
  border: 1px solid #ccc;
}

/* –°–ø–∏—Å–æ–∫ —Ä—è–¥–∫—ñ–≤ */
.item-row {
  display: flex;
  align-items: center;
  gap: 4px;
  background: #fff;
  padding: 4px;
  border-radius: 5px;
  margin-bottom: 3px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  flex-wrap: wrap;
}
.item-row.have {
  background: #d4edda;
}
.item-row input[type=text] {
  width: 100px;
  padding: 2px;
  font-size: 12px;
  border-radius: 4px;
  border: 1px solid #ccc;
}
.item-row input[type=number] {
  width: 40px;
  padding: 2px;
  font-size: 12px;
  border-radius: 4px;
  border: 1px solid #ccc;
}
.item-row input[type=checkbox] {
  width: auto;
  margin: 0;
}
.item-row button.small {
  padding: 2px 4px;
  font-size: 12px;
  border-radius: 4px;
  border: 1px solid #ccc;
  cursor: pointer;
}
.item-row span {
  font-size: 12px;
}

/* –í—ñ–¥–º—ñ—á–µ–Ω—ñ —Ä–µ—á—ñ –ø—ñ–¥ —Ç–∞–±–ª–∏—Ü–µ—é */
#marked-items {
  margin-top: 6px;
  padding: 4px;
  background: #e9f7ef;
  border-radius: 5px;
  font-size: 12px;
}
#marked-items h3 {
  margin: 0 0 3px 0;
  font-size: 12px;
}

@media(max-width:600px){
  .item-row {
    flex-wrap: wrap;
    justify-content: space-between;
  }
  .item-row input[type=text] {
    width: 80px;
  }
  .item-row input[type=number] {
    width: 35px;
  }
  .tabs button {
    font-size: 11px;
    padding: 6px;
  }
  .controls input[type=text] {
    font-size: 11px;
    padding: 4px;
  }
}
section {
  display: none;
}
section.active {
  display: block;
}
</style>
</head>
<body>

<h1>üõ°Ô∏è –ü–ª–∞–Ω –±–µ–∑–ø–µ–∫–∏</h1>

<div class="controls">
  <label>–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å:
    <select id="hoursSelect">
      <option value="24">24 –≥–æ–¥</option>
      <option value="48">48 –≥–æ–¥</option>
      <option value="72" selected>72 –≥–æ–¥</option>
    </select>
  </label>
  <button onclick="showMissing()">üîç –í—ñ–¥—Å—É—Ç–Ω—î</button>
  <button onclick="showAll()">üîÅ –í—Å–µ</button>
  <button onclick="exportCSV()">üìä Excel</button>
  <button onclick="exportPDF()">üìÑ PDF</button>
  <button onclick="resetData()">‚ôªÔ∏è –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ —à–∞–±–ª–æ–Ω</button>
  <input type="text" id="searchInput" placeholder="–ü–æ—à—É–∫..." oninput="searchItems()">
</div>

<div class="tabs">
  <button data-tab="home">üè† –í–¥–æ–º–∞</button>
  <button data-tab="evac">üéí –ï–≤–∞–∫—É–∞—Ü—ñ—è</button>
  <button data-tab="car">üöó –ê–≤—Ç–æ</button>
</div>

<section id="home"></section>
<section id="evac"></section>
<section id="car"></section>

<div id="marked-items"></div>

<script>
let hours = "72";

const baseData = {
  home: { title:"üè† –í–¥–æ–º–∞", items:[
      {name:"–í–æ–¥–∞ (–ª)", base:3, perDay:true},
      {name:"–á–∂–∞", base:2, perDay:true},
      {name:"–ê–ø—Ç–µ—á–∫–∞", base:1, perDay:false},
      {name:"–†–∞–¥—ñ–æ", base:1, perDay:false},
      {name:"–õ—ñ—Ö—Ç–∞—Ä–∏–∫", base:1, perDay:false}
  ]},
  evac: { title:"üéí –ï–≤–∞–∫—É–∞—Ü—ñ—è", items:[
      {name:"CB-—Ä–∞—Ü—ñ—è", base:1, perDay:false},
      {name:"–ó–∞–ø–∞—Å–Ω–∏–π –∞–∫—É–º—É–ª—è—Ç–æ—Ä", base:1, perDay:false},
      {name:"–í–æ–¥–∞ (–ª)", base:2, perDay:true},
      {name:"–á–∂–∞ —à–≤–∏–¥–∫–∞", base:2, perDay:true},
      {name:"–î–æ–∫—É–º–µ–Ω—Ç–∏", base:1, perDay:false}
  ]},
  car: { title:"üöó –ê–≤—Ç–æ", items:[
      {name:"–í–æ–¥–∞ –∑–∞–ø–∞—Å–Ω–∞ (–ª)", base:3, perDay:true},
      {name:"–ê–ø—Ç–µ—á–∫–∞ –∞–≤—Ç–æ", base:1, perDay:false},
      {name:"–ö–æ–≤–¥—Ä–∞", base:2, perDay:false},
      {name:"USB-–∑–∞—Ä—è–¥–∫–∞", base:1, perDay:false}
  ]}
};

let stored = JSON.parse(localStorage.getItem("plan_safe"));
let data = (!stored || !stored.home) ? JSON.parse(JSON.stringify(baseData)) : stored;

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è checked –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —á–∞—Å—É
["home","evac","car"].forEach(sec=>{
  data[sec].items.forEach(item=>{
    if(!item.checked) item.checked={"24":false,"48":false,"72":false};
  });
});

function save(){ localStorage.setItem("plan_safe",JSON.stringify(data)); }
function qty(item){ return item.perDay ? Math.ceil(item.base*(hours/24)) : item.base; }

function render(filter=""){
  ["home","evac","car"].forEach(sectionKey=>{
    const sec = document.getElementById(sectionKey);
    sec.innerHTML = '';
    const title = document.createElement("h2");
    title.textContent = data[sectionKey].title; sec.appendChild(title);

    data[sectionKey].items.forEach((item,idx)=>{
      if(item.name.toLowerCase().includes(filter.toLowerCase())){
        const row = document.createElement("div"); row.className="item-row";

        const chk = document.createElement("input"); chk.type="checkbox";
        chk.checked = item.checked[hours];
        chk.onchange=()=>{ item.checked[hours] = chk.checked; save(); renderMarked(); row.classList.toggle("have",chk.checked); };
        if(chk.checked) row.classList.add("have");
        row.appendChild(chk);

        const inputName = document.createElement("input"); inputName.type="text"; inputName.value=item.name; inputName.onchange=()=>editName(sectionKey,idx,inputName.value); row.appendChild(inputName);

        const inputQty = document.createElement("input"); inputQty.type="number"; inputQty.min=1; inputQty.value=qty(item); inputQty.onchange=()=>editQty(sectionKey,idx,inputQty.value); row.appendChild(inputQty);

        const chkDay = document.createElement("input"); chkDay.type="checkbox"; chkDay.checked=item.perDay; chkDay.onchange=()=>{ item.perDay=chkDay.checked; save(); render(); }; row.appendChild(chkDay);
        const lblDay = document.createElement("span"); lblDay.textContent="–¥–µ–Ω—å"; row.appendChild(lblDay);

        const btnDel = document.createElement("button"); btnDel.className="small"; btnDel.textContent="üóëÔ∏è"; btnDel.onclick=()=>removeItem(sectionKey,idx); row.appendChild(btnDel);

        sec.appendChild(row);
      }
    });

    const btnAdd = document.createElement("button"); btnAdd.textContent="‚ûï –î–æ–¥–∞—Ç–∏ –Ω–æ–≤—É —Ä—ñ—á"; btnAdd.onclick = ()=>addItem(sectionKey); sec.appendChild(btnAdd);
  });
  renderMarked();
}

// ===== –í–Ü–î–ú–Ü–ß–ï–ù–Ü =====
function renderMarked(){
  const div = document.getElementById("marked-items");
  div.innerHTML = "<h3>–í—ñ–¥–º—ñ—á–µ–Ω—ñ —Ä–µ—á—ñ –¥–ª—è " + hours + " –≥–æ–¥</h3>";
  ["home","evac","car"].forEach(sectionKey=>{
    const sec = data[sectionKey];
    sec.items.forEach(item=>{
      if(item.checked[hours]){
        const span = document.createElement("div");
        span.textContent = sec.title + ": " + item.name + " ("+qty(item)+")";
        div.appendChild(span);
      }
    });
  });
}

// ===== –î–Ü–á =====
function editName(section,idx,val){ data[section].items[idx].name=val; save(); render(); }
function editQty(section,idx,val){ let v=Number(val); if(v>0){ data[section].items[idx].base = data[section].items[idx].perDay ? Math.ceil(v/(hours/24)) : v; save(); render(); } }
function addItem(section){ let name=prompt("–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –Ω–æ–≤–æ—ó —Ä–µ—á—ñ","–ù–æ–≤–∞ —Ä—ñ—á"); if(!name) name="–ù–æ–≤–∞ —Ä—ñ—á"; data[section].items.push({name:name, base:1, perDay:false, checked:{"24":false,"48":false,"72":false}}); save(); render(); }
function removeItem(section,idx){ data[section].items.splice(idx,1); save(); render(); }
function searchItems(){ render(document.getElementById("searchInput").value); }

// ===== –í–ò–ü–†–ê–í–õ–ï–ù–Ü –ö–ù–û–ü–ö–ò –í–Ü–î–°–£–¢–ù–Ñ/–í–°–ï =====
function showMissing() {
  ["home","evac","car"].forEach(sectionKey=>{
    data[sectionKey].items.forEach((item,idx)=>{
      const secEl = document.getElementById(sectionKey);
      const row = secEl.children[idx+1]; // +1 —á–µ—Ä–µ–∑ <h2>
      if(row) row.style.display = item.checked[hours] ? "none" : "flex";
    });
  });
}

function showAll() {
  ["home","evac","car"].forEach(sectionKey=>{
    data[sectionKey].items.forEach((item,idx)=>{
      const secEl = document.getElementById(sectionKey);
      const row = secEl.children[idx+1]; // +1 —á–µ—Ä–µ–∑ <h2>
      if(row) row.style.display = "flex";
    });
  });
}

function setHours(h){ hours=h; render(); }
document.getElementById("hoursSelect").addEventListener("change",e=>setHours(e.target.value));

function resetData(){ 
  if(confirm("–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ —à–∞–±–ª–æ–Ω?")){
    data=JSON.parse(JSON.stringify(baseData)); 
    ["home","evac","car"].forEach(sec=>data[sec].items.forEach(item=>item.checked={"24":false,"48":false,"72":false}));
    save(); render(); 
  } 
}

// ===== –ï–ö–°–ü–û–†–¢ =====
function exportCSV(){
  let csv="–°–µ–∫—Ü—ñ—è;–†—ñ—á;–ö—ñ–ª—å–∫—ñ—Å—Ç—å;–î–µ–Ω—å\n";
  ["home","evac","car"].forEach(section=>{
    data[section].items.forEach(item=>csv+=`${data[section].title};${item.name};${qty(item)};${item.perDay?'—Ç–∞–∫':'–Ω—ñ'}\n`);
  });
  const blob=new Blob([csv],{type:"text/csv"}); saveAs(blob,"plan_safe.csv");
}
function exportPDF(){
  const { jsPDF } = window.jspdf; const doc = new jsPDF(); let y=10;
  ["home","evac","car"].forEach(section=>{
    const sec=data[section]; doc.setFontSize(14); doc.text(sec.title,10,y); y+=6;
    sec.items.forEach(item=>{ doc.setFontSize(12); doc.text(`- ${item.name} (${qty(item)}) –¥–µ–Ω—å: ${item.perDay?'—Ç–∞–∫':'–Ω—ñ'}`,10,y); y+=5; });
    y+=4;
  });
  doc.save("plan_safe.pdf");
}

// ===== –í–ö–õ–ê–î–ö–ò =====
const buttons=document.querySelectorAll(".tabs button"); const sections=document.querySelectorAll("section");
function goTab(tab,push=true){ sections.forEach(s=>s.classList.remove("active")); buttons.forEach(b=>b.classList.remove("active")); document.getElementById(tab).classList.add("active"); document.querySelector(`[data-tab="${tab}"]`).classList.add("active"); if(push) history.pushState({tab},"","#"+tab); }
buttons.forEach(b=>b.addEventListener("click",()=>goTab(b.dataset.tab)));
window.addEventListener("popstate",e=>goTab(e.state?.tab||"home",false));

// ===== –°–¢–ê–†–¢ =====
render(); goTab(location.hash.replace("#","")||"home",false);

// ===== SW =====
if("serviceWorker" in navigator){ navigator.serviceWorker.register("sw.js"); }

</script>
</body>
</html>
