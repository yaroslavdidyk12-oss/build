<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–ü–ª–∞–Ω –±–µ–∑–ø–µ–∫–∏</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2f80ed">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
body{font-family:Arial,sans-serif;background:#f2f4f7;margin:0;padding:10px}
h1{text-align:center}
.tabs{display:flex;gap:5px;margin-bottom:10px}
.tabs button{flex:1;padding:10px;border:none;background:#ddd;font-size:15px;cursor:pointer}
.tabs button.active{background:#2f80ed;color:#fff}

.controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:10px}
.controls input[type=text]{padding:5px;flex:1}

section{display:none;background:#fff;padding:10px;border-radius:10px}
section.active{display:block}

table{width:100%;border-collapse:collapse;margin-bottom:10px}
th,td{border:1px solid #ccc;padding:5px;text-align:center}
th{background:#eee}

.have{background:#d4edda}
button.small{padding:3px 6px;font-size:14px}
</style>
</head>

<body>

<h1>üõ°Ô∏è –ü–ª–∞–Ω –±–µ–∑–ø–µ–∫–∏</h1>

<div class="controls">
  <label>–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å:
    <select id="hoursSelect">
      <option value="24">24 –≥–æ–¥</option>
      <option value="48">48 –≥–æ–¥</option>
      <option value="72" selected>72 –≥–æ–¥</option>
    </select>
  </label>
  <button onclick="showMissing()">üîç –í—ñ–¥—Å—É—Ç–Ω—î</button>
  <button onclick="showAll()">üîÅ –í—Å–µ</button>
  <button onclick="exportCSV()">üìä Excel</button>
  <button onclick="exportPDF()">üìÑ PDF</button>
  <button onclick="resetData()">‚ôªÔ∏è –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ —à–∞–±–ª–æ–Ω</button>
  <input type="text" id="searchInput" placeholder="–ü–æ—à—É–∫..." oninput="searchItems()">
</div>

<div class="tabs">
  <button data-tab="home">üè† –í–¥–æ–º–∞</button>
  <button data-tab="evac">üéí –ï–≤–∞–∫—É–∞—Ü—ñ—è</button>
  <button data-tab="car">üöó –ê–≤—Ç–æ</button>
</div>

<section id="home"></section>
<section id="evac"></section>
<section id="car"></section>

<script>
let hours = 72;

const baseData = {
  home: {
    title:"üè† –í–¥–æ–º–∞",
    items:[
      {name:"–í–æ–¥–∞ (–ª)", base:3, perDay:true},
      {name:"–á–∂–∞", base:2, perDay:true},
      {name:"–ê–ø—Ç–µ—á–∫–∞", base:1, perDay:false},
      {name:"–†–∞–¥—ñ–æ", base:1, perDay:false},
      {name:"–õ—ñ—Ö—Ç–∞—Ä–∏–∫", base:1, perDay:false}
    ]
  },
  evac: {
    title:"üéí –ï–≤–∞–∫—É–∞—Ü—ñ—è",
    items:[
      {name:"CB-—Ä–∞—Ü—ñ—è", base:1, perDay:false},
      {name:"–ó–∞–ø–∞—Å–Ω–∏–π –∞–∫—É–º—É–ª—è—Ç–æ—Ä", base:1, perDay:false},
      {name:"–í–æ–¥–∞ (–ª)", base:2, perDay:true},
      {name:"–á–∂–∞ —à–≤–∏–¥–∫–∞", base:2, perDay:true},
      {name:"–î–æ–∫—É–º–µ–Ω—Ç–∏", base:1, perDay:false}
    ]
  },
  car: {
    title:"üöó –ê–≤—Ç–æ",
    items:[
      {name:"–í–æ–¥–∞ –∑–∞–ø–∞—Å–Ω–∞ (–ª)", base:3, perDay:true},
      {name:"–ê–ø—Ç–µ—á–∫–∞ –∞–≤—Ç–æ", base:1, perDay:false},
      {name:"–ö–æ–≤–¥—Ä–∞", base:2, perDay:false},
      {name:"USB-–∑–∞—Ä—è–¥–∫–∞", base:1, perDay:false}
    ]
  }
};

let data = JSON.parse(localStorage.getItem("plan_safe")) || JSON.parse(JSON.stringify(baseData));

// ===== –§–£–ù–ö–¶–Ü–á =====
function save(){ localStorage.setItem("plan_safe",JSON.stringify(data)); }
function qty(item){ return item.perDay ? Math.ceil(item.base*(hours/24)) : item.base; }

function render(filter=""){
  ["home","evac","car"].forEach(sectionKey=>{
    const sec = document.getElementById(sectionKey);
    sec.innerHTML = `<h2>${data[sectionKey].title}</h2><table><tr><th>–ú–∞—é</th><th>–†—ñ—á</th><th>–ö-—Å—Ç—å</th><th>–î–µ–Ω—å</th><th>–î—ñ—è</th></tr>`;
    data[sectionKey].items.forEach((item,idx)=>{
      if(item.name.toLowerCase().includes(filter.toLowerCase())){
        sec.innerHTML += `<tr>
          <td><input type="checkbox" onchange="this.closest('tr').classList.toggle('have',this.checked)"></td>
          <td><input type="text" value="${item.name}" onchange="editName('${sectionKey}',${idx},this.value)"></td>
          <td><input type="number" value="${qty(item)}" min="1" onchange="editQty('${sectionKey}',${idx},this.value)"></td>
          <td><input type="checkbox" ${item.perDay?'checked':''} onchange="item.perDay=this.checked;save();render('${filter}')">–¥–µ–Ω—å</td>
          <td><button class="small" onclick="removeItem('${sectionKey}',${idx})">üóëÔ∏è</button></td>
        </tr>`;
      }
    });
    sec.innerHTML += `</table><button onclick="addItem('${sectionKey}')">‚ûï –î–æ–¥–∞—Ç–∏ –Ω–æ–≤—É —Ä—ñ—á</button>`;
  });
}

// ===== –î–Ü–á =====
function editName(section,idx,value){ data[section].items[idx].name=value; save(); }
function editQty(section,idx,value){ 
  let v=Number(value);
  if(v>0){ data[section].items[idx].base = data[section].items[idx].perDay ? Math.ceil(v/(hours/24)) : v; save(); render(); }
}
function addItem(section){
  let name=prompt("–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –Ω–æ–≤–æ—ó —Ä–µ—á—ñ","–ù–æ–≤–∞ —Ä—ñ—á"); if(!name) name="–ù–æ–≤–∞ —Ä—ñ—á";
  if(!data[section].items) data[section].items = [];
  data[section].items.push({name:name, base:1, perDay:false});
  save(); render();
}
function removeItem(section,idx){ data[section].items.splice(idx,1); save(); render(); }
function searchItems(){ render(document.getElementById("searchInput").value); }
function showMissing(){ document.querySelectorAll("tr").forEach(r=>{ const c=r.querySelector("input[type=checkbox]"); if(c && !c.checked) r.style.display="table-row"; else r.style.display="none"; }); }
function showAll(){ document.querySelectorAll("tr").forEach(r=>r.style.display="table-row"); }
function setHours(h){ hours=h; render(); }
document.getElementById("hoursSelect").addEventListener("change",e=>setHours(Number(e.target.value)));
function resetData(){ if(confirm("–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ —à–∞–±–ª–æ–Ω?")){ data=JSON.parse(JSON.stringify(baseData)); save(); render(); } }

// ===== –ï–ö–°–ü–û–†–¢ =====
function exportCSV(){
  let csv="–°–µ–∫—Ü—ñ—è;–†—ñ—á;–ö—ñ–ª—å–∫—ñ—Å—Ç—å;–î–µ–Ω—å\n";
  ["home","evac","car"].forEach(sectionKey=>{
    data[sectionKey].items.forEach(item=>{
      csv+=`${data[sectionKey].title};${item.name};${qty(item)};${item.perDay?'—Ç–∞–∫':'–Ω—ñ'}\n`;
    });
  });
  const blob=new Blob([csv],{type:"text/csv"});
  saveAs(blob,"plan_safe.csv");
}

function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y=10;
  ["home","evac","car"].forEach(sectionKey=>{
    const sec=data[sectionKey];
    doc.setFontSize(14); doc.text(sec.title,10,y); y+=6;
    sec.items.forEach(item=>{
      doc.setFontSize(12); doc.text(`- ${item.name} (${qty(item)}) –¥–µ–Ω—å: ${item.perDay?'—Ç–∞–∫':'–Ω—ñ'}`,10,y); y+=5;
    });
    y+=4;
  });
  doc.save("plan_safe.pdf");
}

// ===== –í–ö–õ–ê–î–ö–ò =====
const buttons=document.querySelectorAll(".tabs button");
const sections=document.querySelectorAll("section");
function goTab(tab,push=true){
  sections.forEach(s=>s.classList.remove("active"));
  buttons.forEach(b=>b.classList.remove("active"));
  document.getElementById(tab).classList.add("active");
  document.querySelector(`[data-tab="${tab}"]`).classList.add("active");
  if(push) history.pushState({tab},"","#"+tab);
}
buttons.forEach(b=>b.addEventListener("click",()=>goTab(b.dataset.tab)));
window.addEventListener("popstate",e=>goTab(e.state?.tab||"home",false));

// ===== –°–¢–ê–†–¢ =====
render();
goTab(location.hash.replace("#","")||"home",false);

// ===== SW =====
if("serviceWorker" in navigator){ navigator.serviceWorker.register("sw.js"); }

</script>
</body>
</html>
