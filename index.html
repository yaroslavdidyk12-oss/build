<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–ü–ª–∞–Ω –±–µ–∑–ø–µ–∫–∏</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2f80ed">

<style>
body{font-family:Arial,sans-serif;background:#f2f4f7;padding:15px;color:#333;}
h1{text-align:center;margin-bottom:15px;}
section{background:#fff;padding:15px;margin-bottom:20px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
table{width:100%;border-collapse:collapse;}
th,td{border:1px solid #ccc;padding:6px;vertical-align:middle;}
th{background:#eee;text-align:left;}
.have{background:#d4edda;}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;justify-content:center;}
button,select,input[type=number],input[type=text]{padding:6px;border-radius:4px;border:1px solid #ccc;}
input[type=text]{width:90%;box-sizing:border-box;}
input[type=number]{width:60px;}
td.flex-cell{display:flex;align-items:center;gap:5px;}
td.flex-cell input[type=checkbox]{width:auto;margin:0;}
td.flex-cell input[type=number]{width:50px;}
tr:hover{background:#f1f1f1;}
@media(max-width:600px){
 table, tr, th, td{display:block;width:100%;box-sizing:border-box;}
 tr{margin-bottom:10px;border-bottom:2px solid #ccc;}
 th{display:none;}
 td{border:none;padding:4px 0;}
 td.flex-cell{display:flex;justify-content:space-between;}
 td:nth-child(2){font-weight:bold;margin-bottom:5px;}
}
</style>
</head>
<body>

<h1>üõ°Ô∏è –ü–ª–∞–Ω –±–µ–∑–ø–µ–∫–∏</h1>

<div class="controls">
<label>–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å:
<select onchange="setHours(this.value)">
<option value="24">24 –≥–æ–¥</option>
<option value="48">48 –≥–æ–¥</option>
<option value="72" selected>72 –≥–æ–¥</option>
</select>
</label>
<button onclick="showMissing()">üîç –í—ñ–¥—Å—É—Ç–Ω—î</button>
<button onclick="showAll()">üîÅ –í—Å–µ</button>
<button onclick="exportCSV()">üìä Excel</button>
<button onclick="window.print()">üìÑ PDF</button>
<button onclick="resetData()">‚ôªÔ∏è –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ —à–∞–±–ª–æ–Ω</button>
<input type="text" id="searchInput" placeholder="–ü–æ—à—É–∫..." oninput="searchItems()">
</div>

<div id="app"></div>

<script>
// ==================== PWA BACK BUTTON ====================
const currentSection = { value: "home" };

// –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
window.addEventListener("load", ()=>{
  history.replaceState({section:"home"}, "", "#home");
  currentSection.value = "home";
});

// –û–±—Ä–æ–±–∫–∞ –∫–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥
window.addEventListener("popstate", function(e){
  const sec = e.state?.section || "home";
  showOnlySection(sec);
});

// –ü–æ–∫–∞–∑–∞—Ç–∏ –ª–∏—à–µ –æ–¥–Ω—É —Å–µ–∫—Ü—ñ—é
function showOnlySection(sectionKey){
  document.querySelectorAll("section").forEach(sec=>sec.style.display="none");
  const el = document.getElementById(sectionKey);
  if(el) el.style.display="block";
  currentSection.value = sectionKey;
}

// ==================== PWA APP LOGIC ====================
let hours = 72;

const baseData = {
 home:{title:"üè† –í–¥–æ–º–∞",items:[
  {name:"–í–æ–¥–∞ (–ª)",base:3,perDay:true},
  {name:"–á–∂–∞",base:2,perDay:true},
  {name:"–ê–ø—Ç–µ—á–∫–∞",base:1,perDay:false},
  {name:"–†–∞–¥—ñ–æ",base:1,perDay:false},
  {name:"–õ—ñ—Ö—Ç–∞—Ä–∏–∫",base:1,perDay:false}
 ]},
 evac:{title:"üéí –ï–≤–∞–∫—É–∞—Ü—ñ—è",items:[
  {name:"CB-—Ä–∞—Ü—ñ—è",base:1,perDay:false},
  {name:"–ó–∞–ø–∞—Å–Ω–∏–π –∞–∫—É–º—É–ª—è—Ç–æ—Ä",base:1,perDay:false},
  {name:"–í–æ–¥–∞ (–ª)",base:2,perDay:true},
  {name:"–á–∂–∞ —à–≤–∏–¥–∫–∞",base:2,perDay:true},
  {name:"–î–æ–∫—É–º–µ–Ω—Ç–∏",base:1,perDay:false}
 ]},
 car:{title:"üöó –ê–≤—Ç–æ",items:[
  {name:"–í–æ–¥–∞ –∑–∞–ø–∞—Å–Ω–∞ (–ª)",base:3,perDay:true},
  {name:"–ê–ø—Ç–µ—á–∫–∞ –∞–≤—Ç–æ",base:1,perDay:false},
  {name:"–ö–æ–≤–¥—Ä–∞",base:2,perDay:false},
  {name:"USB-–∑–∞—Ä—è–¥–∫–∞",base:1,perDay:false}
 ]}
};

let data = JSON.parse(localStorage.getItem("plan_safe")) || baseData;

function setHours(h){ hours = h; render(); }
function qty(item){ return item.perDay ? Math.ceil(item.base*(hours/24)) : item.base; }
function save(){ localStorage.setItem("plan_safe",JSON.stringify(data)); }

function render(filter=""){
 const app = document.getElementById("app");
 app.innerHTML = "";

 Object.keys(data).forEach(sectionKey => {
   const sec = data[sectionKey];
   const sectionEl = document.createElement("section");
   sectionEl.id = sectionKey;

   const titleEl = document.createElement("h2");
   titleEl.textContent = sec.title;
   sectionEl.appendChild(titleEl);

   const table = document.createElement("table");
   const header = document.createElement("tr");
   header.innerHTML = "<th>–ú–∞—é</th><th>–†—ñ—á</th><th>–ö-—Å—Ç—å</th><th>–î–µ–Ω—å</th><th>–î—ñ—è</th>";
   table.appendChild(header);

   sec.items.forEach((item, idx) => {
     if(item.name.toLowerCase().includes(filter.toLowerCase())){
       const tr = document.createElement("tr");

       const tdHave = document.createElement("td");
       tdHave.className="flex-cell";
       const checkbox = document.createElement("input");
       checkbox.type="checkbox";
       checkbox.onchange = function(){ tr.classList.toggle("have", this.checked); };
       tdHave.appendChild(checkbox);

       const tdName = document.createElement("td");
       const inputName = document.createElement("input");
       inputName.type = "text";
       inputName.value = item.name;
       inputName.onchange = function(){ editName(sectionKey, idx, this.value); };
       tdName.appendChild(inputName);

       const tdQty = document.createElement("td");
       const inputQty = document.createElement("input");
       inputQty.type = "number";
       inputQty.value = qty(item);
       inputQty.min = 1;
       inputQty.onchange = function(){ editQty(sectionKey, idx, this.value); };
       tdQty.appendChild(inputQty);

       const tdPerDay = document.createElement("td");
       const inputPerDay = document.createElement("input");
       inputPerDay.type = "checkbox";
       inputPerDay.checked = item.perDay;
       inputPerDay.onchange = function(){ item.perDay = this.checked; save(); render(); };
       tdPerDay.appendChild(inputPerDay);
       const label = document.createElement("span");
       label.textContent = "–¥–µ–Ω—å";
       tdPerDay.appendChild(label);

       const tdRemove = document.createElement("td");
       const btnRemove = document.createElement("button");
       btnRemove.textContent = "üóëÔ∏è";
       btnRemove.onclick = function(){ removeItem(sectionKey, idx); };
       tdRemove.appendChild(btnRemove);

       tr.appendChild(tdHave);
       tr.appendChild(tdName);
       tr.appendChild(tdQty);
       tr.appendChild(tdPerDay);
       tr.appendChild(tdRemove);

       table.appendChild(tr);
     }
   });

   sectionEl.appendChild(table);

   const addBtn = document.createElement("button");
   addBtn.textContent = "‚ûï –î–æ–¥–∞—Ç–∏ –Ω–æ–≤—É —Ä—ñ—á";
   addBtn.onclick = function(){ addItem(sectionKey); };
   sectionEl.appendChild(addBtn);

   app.appendChild(sectionEl);
 });
 showOnlySection(currentSection.value);
}

// ======== CRUD FUNCTIONS ========
function editName(section, idx, value){ data[section].items[idx].name = value; save(); }
function editQty(section, idx, value){ 
  let v = Number(value);
  if(v>0){
    data[section].items[idx].base = data[section].items[idx].perDay ? Math.ceil(v/(hours/24)) : v;
    save(); render();
  }
}
function addItem(section){
  let name = prompt("–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –Ω–æ–≤–æ—ó —Ä–µ—á—ñ","–ù–æ–≤–∞ —Ä—ñ—á");
  if(!name) name="–ù–æ–≤–∞ —Ä—ñ—á";
  data[section].items.push({name:name,base:1,perDay:false});
  save(); render();
}
function removeItem(section, idx){ data[section].items.splice(idx,1); save(); render(); }
function searchItems(){ const val = document.getElementById("searchInput").value; render(val); }
function showMissing(){ document.querySelectorAll("tr").forEach(r => { const c=r.querySelector("input[type=checkbox]"); if(c && !c.checked) r.style.display="table-row"; else r.style.display="none"; }); }
function showAll(){ document.querySelectorAll("tr").forEach(r => r.style.display="table-row"); }
function exportCSV(){
  let csv = "–°–µ–∫—Ü—ñ—è;–†—ñ—á;–ö—ñ–ª—å–∫—ñ—Å—Ç—å;–î–µ–Ω—å\n";
  Object.keys(data).forEach(sectionKey=>{
    const sec = data[sectionKey];
    sec.items.forEach(item=>{
      csv += `${sec.title};${item.name};${qty(item)};${item.perDay ? "—Ç–∞–∫" : "–Ω—ñ"}\n`;
    });
  });
  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "plan_safe.csv";
  a.click();
}
function resetData(){ if(confirm("–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ —à–∞–±–ª–æ–Ω?")){ data = JSON.parse(JSON.stringify(baseData)); save(); render(); } }

render();

// ==================== REGISTER SERVICE WORKER ====================
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}

</script>
</body>
</html>
